<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4 Wheels with Layers Panel</title>
    <style>
        :root {
            --bg: #0f1724;
            --panel: #0b1220;
            --accent: #60a5fa;
            --muted: #94a3b8;
            --card: #0b1226;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Inter, Segoe UI, Roboto, Arial, sans-serif;
            background: linear-gradient(180deg, #071025 0%, #081428 60%);
            color: #e6eef8;
        }

        .wrap {
            display: flex;
            flex-direction: column;
            /* vertical stacking */
            gap: 18px;
            padding: 18px;
            align-items: center;
            /* center horizontally */
        }

        .wheelWrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 420px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
        }

        canvas {
            background: transparent;
            display: block;
            margin: 0 auto;
            /* center canvas horizontally */
        }

        .controls {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            padding: 8px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .topbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        button {
            padding: 6px 10px;
            border-radius: 6px;
            border: 0;
            background: linear-gradient(90deg, var(--accent), #7dd3fc);
            color: #012;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--muted);
        }

        h2 {
            margin: 4px 0 8px 0;
            font-size: 16px;
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.02);
            color: inherit;
        }

        .layers-list {
            max-height: 120px;
            overflow: auto;
            margin-top: 6px;
        }

        .layer-item {
            padding: 6px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.01);
            margin-bottom: 4px;
            cursor: pointer;
        }

        .layer-item.selected {
            outline: 2px solid rgba(96, 165, 250, 0.12);
        }

        .sectorFormBox {
            display: none;
            margin-top: 8px;
            width: 100%;
        }

        .sectorFormBox h3 {
            font-size: 14px;
            margin: 4px 0;
        }

        .sectorFormBox input {
            width: 100%;
            padding: 4px;
            margin-bottom: 4px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .results {
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.02);
            padding: 6px;
            border-radius: 6px;
            font-size: 12px;
        }

        .hint {
            font-size: 12px;
            color: var(--muted);
            text-align: center;
            margin-top: 4px;
        }

        /* Responsive for mobile phones */
        @media (max-width: 480px) {
            .wheelWrap {
                width: 90%;
                padding: 8px;
            }

            canvas {
                width: 100%;
                height: auto;
            }

            .controls {
                padding: 6px;
            }

            button {
                font-size: 14px;
                padding: 6px 8px;
            }
        }
    </style>
</head>

<body>
    <div class="wheelWrap">
        <canvas class="wheelCanvas" width="300" height="300"></canvas>
        <div class="controls">
            <button class="spinBtn" style="margin-top: 10px;">Spin</button>
            <button class="stopBtn" style="margin-bottom: 20px;">Stop</button>
            <div>
                <strong>Selected Layer:</strong> <span class="selLayerName">None</span>
            </div>
            <div>
                <label>Layer Name:</label>
                <input type="text" class="layerNameInput" placeholder="Edit layer name" />
            </div>
            <div class="layers-list"></div>
            <button class="addLayerBtn">Add Layer</button>
            <button class="removeLayerBtn">Remove Layer</button>
            <div>
                <label>Sectors Count:</label>
                <input type="number" class="sectorCountInput" min="2" max="24" style="width:50px" />
                <button class="applySectorsBtn">Apply Count</button>
                <button class="saveSectorsBtn">Save Labels</button>
            </div>
            <div class="sectorFormBox">
                <form class="sectorForm"></form>
            </div>

            <div class="results"></div>
        </div>
    </div>

    <!-- Duplicate wheel example (2nd wheel below first) -->
    <div class="wheelWrap">
        <canvas class="wheelCanvas" width="300" height="300"></canvas>
        <div class="controls">
            <button class="spinBtn" style="margin-top: 10px;">Spin</button>
            <button class="stopBtn" style="margin-bottom: 20px;">Stop</button>
            <div>
                <strong>Selected Layer:</strong> <span class="selLayerName">None</span>
            </div>
            <div>
                <label>Layer Name:</label>
                <input type="text" class="layerNameInput" placeholder="Edit layer name" />
            </div>
            <div class="layers-list"></div>
            <button class="addLayerBtn">Add Layer</button>
            <button class="removeLayerBtn">Remove Layer</button>
            <div>
                <label>Sectors Count:</label>
                <input type="number" class="sectorCountInput" min="2" max="24" style="width:50px" />
                <button class="applySectorsBtn">Apply Count</button>
                <button class="saveSectorsBtn">Save Labels</button>
            </div>
            <div class="sectorFormBox">
                <form class="sectorForm"></form>
            </div>

            <div class="results"></div>
        </div>
    </div>

    <div class="wheelWrap">
        <canvas class="wheelCanvas" width="300" height="300"></canvas>
        <div class="controls">
            <button class="spinBtn" style="margin-top: 10px;">Spin</button>
            <button class="stopBtn" style="margin-bottom: 20px;">Stop</button>
            <div>
                <strong>Selected Layer:</strong> <span class="selLayerName">None</span>
            </div>
            <div>
                <label>Layer Name:</label>
                <input type="text" class="layerNameInput" placeholder="Edit layer name" />
            </div>
            <div class="layers-list"></div>
            <button class="addLayerBtn">Add Layer</button>
            <button class="removeLayerBtn">Remove Layer</button>
            <div>
                <label>Sectors Count:</label>
                <input type="number" class="sectorCountInput" min="2" max="24" style="width:50px" />
                <button class="applySectorsBtn">Apply Count</button>
                <button class="saveSectorsBtn">Save Labels</button>
            </div>
            <div class="sectorFormBox">
                <form class="sectorForm"></form>
            </div>

            <div class="results"></div>
        </div>
    </div>

    <div class="wheelWrap">
        <canvas class="wheelCanvas" width="300" height="300"></canvas>
        <div class="controls">
            <button class="spinBtn" style="margin-top: 10px;">Spin</button>
            <button class="stopBtn" style="margin-bottom: 20px;">Stop</button>
            <div>
                <strong>Selected Layer:</strong> <span class="selLayerName">None</span>
            </div>
            <div>
                <label>Layer Name:</label>
                <input type="text" class="layerNameInput" placeholder="Edit layer name" />
            </div>
            <div class="layers-list"></div>
            <button class="addLayerBtn">Add Layer</button>
            <button class="removeLayerBtn">Remove Layer</button>
            <div>
                <label>Sectors Count:</label>
                <input type="number" class="sectorCountInput" min="2" max="24" style="width:50px" />
                <button class="applySectorsBtn">Apply Count</button>
                <button class="saveSectorsBtn">Save Labels</button>
            </div>
            <div class="sectorFormBox">
                <form class="sectorForm"></form>
            </div>

            <div class="results"></div>
        </div>
    </div>

    <script>
        class Wheel {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.cw = canvas.width;
                this.ch = canvas.height;
                this.cx = this.cw / 2;
                this.cy = this.ch / 2;
                this.layers = [];
                this.selectedLayerId = null;
                this.running = false;
                this.animationId = null;

                const wrap = canvas.parentElement;
                this.layersListEl = wrap.querySelector('.layers-list');
                this.selLayerNameEl = wrap.querySelector('.selLayerName');
                this.sectorCountInput = wrap.querySelector('.sectorCountInput');
                this.sectorFormBox = wrap.querySelector('.sectorFormBox');
                this.sectorForm = wrap.querySelector('.sectorForm');
                this.resultsBox = wrap.querySelector('.results');
                this.layerNameInput = wrap.querySelector('.layerNameInput');

                // popup for showing results
                this.popup = document.createElement('div');
                Object.assign(this.popup.style, {
                    position: 'absolute',
                    left: canvas.offsetLeft + 'px',
                    top: canvas.offsetTop + 'px',
                    width: canvas.width + 'px',
                    height: canvas.height + 'px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: '#fff',
                    fontWeight: '700',
                    fontSize: '20px',
                    pointerEvents: 'auto',
                    textAlign: 'center',
                    border: '3px solid #60a5fa',
                    borderRadius: '12px',
                    background: 'rgba(0,0,0,0.7)',
                    boxShadow: '0 4px 20px rgba(0,0,0,0.5)',
                    opacity: 0,
                    cursor: 'pointer',
                    transition: 'opacity 0.3s'
                });
                canvas.parentElement.appendChild(this.popup);
                this.popup.addEventListener('click', () => { this.popup.style.opacity = 0; });

                canvas.addEventListener('dblclick', e => this.onDblClick(e));
                canvas.addEventListener('click', e => this.onClick(e));

                // Load saved layers or create default
                this.loadFromStorage() || this.initDefaultLayers();

                // Listen for layer name input changes
                if (this.layerNameInput) {
                    this.layerNameInput.addEventListener('input', (e) => {
                        if (!this.selectedLayerId) return;
                        const layer = this.layers.find(l => l.id === this.selectedLayerId);
                        layer.name = e.target.value.trim() || `Layer ${this.layers.findIndex(l => l.id === this.selectedLayerId) + 1}`;
                        this.refreshLayerList();
                        this.showResults(); // <-- update results instantly
                        this.saveToStorage();
                    });
                }

                this.draw();
                this.refreshLayerList();
            }

            initDefaultLayers() {
                this.createLayer(8);
                this.createLayer(6);
                this.createLayer(4);
            }

            randColor(i) {
                const hues = [15, 28, 42, 120, 190, 220, 270, 330];
                const h = hues[i % hues.length] + (i * 13) % 30;
                return `hsl(${h} 70% 60%)`;
            }

            degToRad(d) { return d * Math.PI / 180; }
            radToDeg(r) { return r * 180 / Math.PI; }

            wrapText(ctx, text, x, y, maxWidth, lineHeight) {
                const words = text.split(' ');
                let line = ''; let lineCount = 0;
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n] + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && n > 0) {
                        ctx.fillStyle = "#031428";
                        ctx.fillText(line.trim(), x, y + lineCount * lineHeight);
                        line = words[n] + ' '; lineCount++;
                    } else { line = testLine; }
                }
                ctx.fillStyle = "#031428";
                ctx.fillText(line.trim(), x, y + lineCount * lineHeight);
            }

            recomputeRadii() {
                const totalSpace = Math.min(this.cw, this.ch) / 2 - 12;
                if (this.layers.length === 0) return;
                const spacing = 6;
                const ringWidth = Math.floor((totalSpace - (this.layers.length - 1) * spacing) / this.layers.length);
                for (let i = 0; i < this.layers.length; i++) {
                    const outer = totalSpace - (i * (ringWidth + spacing));
                    const inner = outer - ringWidth;
                    this.layers[i].radiusOuter = outer;
                    this.layers[i].radiusInner = inner;
                }
            }

            draw() {
                const ctx = this.ctx;
                ctx.clearRect(0, 0, this.cw, this.ch);
                for (let L = 0; L < this.layers.length; L++) {
                    const layer = this.layers[L];
                    const n = layer.sectors.length;
                    const outer = layer.radiusOuter, inner = layer.radiusInner;
                    const arc = 2 * Math.PI / n;
                    for (let i = 0; i < n; i++) {
                        const a0 = -Math.PI / 2 + (i * arc) + this.degToRad(layer.rotationDeg);
                        const a1 = a0 + arc;
                        ctx.beginPath();
                        ctx.moveTo(this.cx, this.cy);
                        ctx.arc(this.cx, this.cy, outer, a0, a1);
                        ctx.arc(this.cx, this.cy, inner, a1, a0, true);
                        ctx.closePath();
                        ctx.fillStyle = this.randColor(L + i);
                        ctx.fill();
                        ctx.strokeStyle = "rgba(0,0,0,0.35)";
                        ctx.lineWidth = 0.8;
                        ctx.stroke();

                        const mid = (a0 + a1) / 2;
                        const label = layer.sectors[i].label;
                        ctx.save();
                        const labelRadius = (inner + outer) / 2;
                        ctx.translate(this.cx + Math.cos(mid) * labelRadius, this.cy + Math.sin(mid) * labelRadius);
                        ctx.rotate(mid + Math.PI / 2);
                        const fontSize = Math.max(8, (outer - inner) * 0.25);
                        ctx.font = `${fontSize}px system-ui,Arial`;
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        this.wrapText(ctx, label, 0, 0, (outer - inner) * 1.4, fontSize * 0.9);
                        ctx.restore();
                    }
                }
                // pointer
                const lastInner = this.layers.length ? this.layers[this.layers.length - 1].radiusInner : 20;
                ctx.beginPath();
                ctx.moveTo(this.cx, this.cy - lastInner - 12);
                ctx.lineTo(this.cx - 10, this.cy - lastInner + 12);
                ctx.lineTo(this.cx + 10, this.cy - lastInner + 12);
                ctx.closePath();
                ctx.fillStyle = "#fff";
                ctx.fill();
            }

            createLayer(sectors = 6) {
                const id = Date.now().toString(36) + Math.floor(Math.random() * 1000);
                const layer = {
                    id,
                    name: `Layer ${this.layers.length + 1}`,
                    sectors: [],
                    rotationDeg: 0,
                    isSpinning: false,
                    targetDeg: 0
                };
                for (let i = 0; i < sectors; i++) layer.sectors.push({ label: `Item ${i + 1}` });
                this.layers.push(layer);
                this.recomputeRadii();
                this.selectLayer(id);
                this.draw();
                this.refreshLayerList();
                this.saveToStorage();
            }

            selectLayer(id) {
                this.selectedLayerId = id;
                this.refreshLayerList();
                this.draw();
                this.showSectorForm(this.layers.find(l => l.id === id));

                const layer = this.layers.find(l => l.id === id);
                if (this.layerNameInput) this.layerNameInput.value = layer.name;
            }

            refreshLayerList() {
                this.layersListEl.innerHTML = '';
                this.layers.forEach((l, i) => {
                    const item = document.createElement('div');
                    item.className = 'layer-item' + (l.id === this.selectedLayerId ? ' selected' : '');
                    item.innerHTML = `<div><strong>${l.name}</strong> <div class="small">${l.sectors.length} sectors</div></div>
            <div class="small">id:${l.id.slice(-4)}</div>`;
                    item.onclick = () => this.selectLayer(l.id);
                    this.layersListEl.appendChild(item);
                });
                this.selLayerNameEl.textContent = this.selectedLayerId ? this.layers.find(l => l.id === this.selectedLayerId).name : 'None';
            }

            showSectorForm(layer) {
                if (!layer) { this.sectorFormBox.style.display = 'none'; return; }
                this.sectorFormBox.style.display = 'block';
                this.sectorForm.innerHTML = '';
                layer.sectors.forEach((sec, i) => {
                    const div = document.createElement('div');
                    div.style.marginBottom = "4px";
                    div.innerHTML = `<label class="small">Sector ${i + 1}</label>
            <input type="text" data-idx="${i}" value="${sec.label}"/>`;
                    this.sectorForm.appendChild(div);
                });
            }

            saveSectorLabels() {
                if (!this.selectedLayerId) return;
                const layer = this.layers.find(l => l.id === this.selectedLayerId);
                const inputs = this.sectorForm.querySelectorAll('input[type=text]');
                inputs.forEach(input => {
                    const idx = parseInt(input.dataset.idx);
                    layer.sectors[idx].label = input.value.trim() || `Item ${idx + 1}`;
                });
                this.draw();
                this.refreshLayerList();
                this.showResults();
                this.saveToStorage();
            }

            applySectorCount() {
                if (!this.selectedLayerId) return;
                const n = parseInt(this.sectorCountInput.value);
                if (isNaN(n) || n < 2 || n > 24) return alert('Sectors between 2 and 24');
                const layer = this.layers.find(l => l.id === this.selectedLayerId);
                const cur = layer.sectors.length;
                if (n > cur) {
                    for (let i = cur; i < n; i++) layer.sectors.push({ label: `Item ${i + 1}` });
                } else {
                    layer.sectors.length = n;
                }
                this.draw();
                this.refreshLayerList();
                this.showResults();
                this.saveToStorage();
            }

            removeSelectedLayer() {
                if (!this.selectedLayerId) return alert('Select a layer first');
                const idx = this.layers.findIndex(l => l.id === this.selectedLayerId);
                if (idx >= 0) {
                    this.layers.splice(idx, 1);
                    this.recomputeRadii();
                    this.selectedLayerId = this.layers.length ? this.layers[0].id : null;
                    this.refreshLayerList();
                    this.draw();
                    this.showResults();
                    this.saveToStorage();
                }
            }

            spinAll() {
                if (this.running) return;
                this.running = true;
                this.resultsBox.textContent = "Spinning...";
                const now = performance.now();
                this.layers.forEach((layer, i) => {
                    layer.isSpinning = true;
                    const base = 360 * (3 + Math.floor(Math.random() * 3));
                    const extra = Math.random() * 360;
                    layer.startDeg = layer.rotationDeg % 360;
                    layer.targetDeg = layer.startDeg + base + extra + (Math.random() * 30 - 15);
                    layer.startTime = now;
                    layer.duration = 2200 + i * 350 + Math.floor(Math.random() * 700);
                });
                this.animate(now);
            }

            stopAll() {
                this.layers.forEach(layer => this.snapLayerToSector(layer));
                this.running = false;
                cancelAnimationFrame(this.animationId);
                this.draw();
                this.showResults();
                this.saveToStorage();
            }

            animate(now) {
                let allStopped = true;
                this.layers.forEach(layer => {
                    if (!layer.isSpinning) return;
                    const elapsed = performance.now() - layer.startTime;
                    const t = Math.min(1, elapsed / layer.duration);
                    const ease = 1 - Math.pow(1 - t, 3);
                    layer.rotationDeg = layer.startDeg + (layer.targetDeg - layer.startDeg) * ease;
                    if (t >= 1) {
                        layer.isSpinning = false;
                        this.snapLayerToSector(layer);
                    } else allStopped = false;
                });
                this.draw();
                if (allStopped) { this.running = false; this.showResults(); this.saveToStorage(); }
                else this.animationId = requestAnimationFrame(() => this.animate());
            }

            snapLayerToSector(layer) {
                const n = layer.sectors.length;
                const rot = ((layer.rotationDeg % 360) + 360) % 360;
                const anglePer = 360 / n;
                let pointerAngle = -90 - rot;
                pointerAngle = ((pointerAngle % 360) + 360) % 360;
                let idx = Math.floor(pointerAngle / anglePer);
                idx = (n - idx) % n;
                const sectorMid = idx * anglePer + anglePer / 2;
                const targetRot = 0 - sectorMid;
                const k = Math.round((rot - targetRot) / 360);
                const finalRot = targetRot + k * 360;
                layer.rotationDeg += finalRot - rot;
                layer.rotationDeg = ((layer.rotationDeg % 360) + 360) % 360;
                layer.selectedIndex = idx;
            }

            showResults() {
                if (this.layers.length === 0) return;

                let html = '';
                this.layers.forEach((l) => {
                    const idx = (l.selectedIndex === undefined) ? this.computeSelectedIndex(l) : l.selectedIndex;
                    const label = l.sectors[idx] ? l.sectors[idx].label : '—';
                    html += `${l.name}: ${label}<br>`;
                });
                this.popup.innerHTML = html;
                this.popup.style.opacity = 1;

                if (this.resultsBox) {
                    let list = '<ul style="padding-left:18px;margin:0">';
                    this.layers.forEach((l) => {
                        const idx = (l.selectedIndex === undefined) ? this.computeSelectedIndex(l) : l.selectedIndex;
                        const label = l.sectors[idx] ? l.sectors[idx].label : '—';
                        list += `<li><strong>${l.name}:</strong> Sector ${idx + 1} — ${label}</li>`;
                    });
                    list += '</ul>';
                    this.resultsBox.innerHTML = list;
                }
            }

            computeSelectedIndex(layer) {
                const n = layer.sectors.length;
                const rot = ((layer.rotationDeg % 360) + 360) % 360;
                let pointerAngle = 0 - rot;
                pointerAngle = ((pointerAngle % 360) + 360) % 360;
                let idx = Math.floor(pointerAngle / (360 / n));
                idx = (n - idx) % n;
                return idx;
            }

            onDblClick(ev) {
                const rect = this.canvas.getBoundingClientRect();
                const x = ev.clientX - rect.left;
                const y = ev.clientY - rect.top;
                const dx = x - this.cx, dy = y - this.cy;
                const dist = Math.sqrt(dx * dx + dy * dy);
                for (let layer of this.layers) {
                    if (dist <= layer.radiusOuter && dist >= layer.radiusInner) {
                        let ang = Math.atan2(dy, dx);
                        let deg = this.radToDeg(ang);
                        let rot = layer.rotationDeg;
                        let relative = ((deg + 90 - rot) % 360 + 360) % 360;
                        const n = layer.sectors.length;
                        const idx = Math.floor(relative / (360 / n));
                        const cur = layer.sectors[idx] ? layer.sectors[idx].label : '';
                        const newLabel = prompt('Edit sector label:', cur);
                        if (newLabel !== null) { layer.sectors[idx].label = newLabel.trim() || cur; this.draw(); this.saveToStorage(); this.showResults(); }
                        return;
                    }
                }
            }

            onClick(ev) {
                const rect = this.canvas.getBoundingClientRect();
                const x = ev.clientX - rect.left;
                const y = ev.clientY - rect.top;
                const dx = x - this.cx, dy = y - this.cy;
                const dist = Math.sqrt(dx * dx + dy * dy);
                for (let li of this.layers) {
                    if (dist <= li.radiusOuter && dist >= li.radiusInner) { this.selectLayer(li.id); return; }
                }
            }

            saveToStorage() {
                const key = 'wheel_' + this.canvas.dataset.id;
                const data = JSON.stringify(this.layers);
                localStorage.setItem(key, data);
            }

            loadFromStorage() {
                const key = 'wheel_' + this.canvas.dataset.id;
                const data = localStorage.getItem(key);
                if (!data) return false;
                try {
                    const layers = JSON.parse(data);
                    this.layers = layers;
                    this.recomputeRadii();
                    this.selectedLayerId = this.layers.length ? this.layers[0].id : null;
                    return true;
                } catch (e) {
                    console.error("Failed to load wheel from storage", e);
                    return false;
                }
            }
        }

        // initialize all wheels
        document.querySelectorAll('.wheelCanvas').forEach((canvas, idx) => {
            canvas.dataset.id = idx; // unique id for localStorage
            const wrap = canvas.parentElement;
            const wheel = new Wheel(canvas);
            wrap.querySelector('.spinBtn').onclick = () => wheel.spinAll();
            wrap.querySelector('.stopBtn').onclick = () => wheel.stopAll();
            wrap.querySelector('.addLayerBtn').onclick = () => wheel.createLayer(6);
            wrap.querySelector('.removeLayerBtn').onclick = () => wheel.removeSelectedLayer();
            wrap.querySelector('.applySectorsBtn').onclick = () => wheel.applySectorCount();
            wrap.querySelector('.saveSectorsBtn').onclick = () => wheel.saveSectorLabels();
        });
    </script>

</body>

</html>